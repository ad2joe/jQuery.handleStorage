/**
 *
 * jQuery plugin to impliment local storage with optional AES
 * encryption support via the Gibberish-AES libraries
 *
 * Fork me @ https://www.github.com/jas-/jQuery.handleStorage
 *
 * FEATURES:
 * - HTML5 localStorage support
 * - HTML5 sessionStorage support
 * - Cookie support
 * - AES encryption support
 *
 * REQUIREMENTS:
 * - jQuery libraries (required - http://www.jquery.com)
 * - jQuery cookie plugin (optional - http://plugins.jquery.com/files/jquery.cookie.js.txt)
 * - Gibberish-AES libraries (optional - https://github.com/mdp/gibberish-aes)
 *
 * OPTIONS:
 * - storage: HTML5 localStorage, sessionStorage and cookies supported
 * - aes:     Use AES encryption for local storage
 * - uuid:    Random RFC-4122 string used as AES password
 *
 * Author: Jason Gerfen
 * Email: jason.gerfen@gmail.com
 * Copyright: Jason Gerfen
 *
 * License: GPL
 *
 */

(function($){$.fn.handleStorage=function(f){methods={init:function(a){var b={storage:'localStorage',aes:false,uuid:'',form:$(this).attr('id')};var c=$.extend({},b,a);handleKey(c);var d=getStorage(c);if((typeof d==='object')&&(size(d)>0)){setForm(c,d)}$('#'+c.form).live('submit',function(e){saveForm(c)})},get:function(a){return((a.aes)&&(a.key))?GibberishAES.dec(getItem(a.storage,a.k),a.key):getItem(a.storage,a.k)},set:function(a){return((a.aes)&&(a.key))?setItem(a.storage,a.k,GibberishAES.enc(a.v,a.key)):setItem(a.storage,a.k,a.v)}};function size(a){var n=0;$.each(a,function(k,v){if(a.hasOwnProperty(k))n++});return n};function setItem(a,k,v){var x=false;a=(validateStorage(a))?a:'cookie';switch(a){case'localStorage':x=setLocal(k,v);break;case'sessionStorage':x=setSession(k,v);break;case'cookie':x=setCookie(k,v);break;default:x=setLocal(k,v);break}return x}function getItem(a,k){var x=false;a=(validateStorage(a))?a:'cookie';switch(a){case'localStorage':x=getLocal(k);break;case'sessionStorage':x=getSession(k);break;case'cookie':x=getCookie(k);break;default:x=getLocal(k);break}return x}function setLocal(k,v){return(localStorage.setItem(k,v))?false:true}function setSession(k,v){return(sessionStorage.setItem(k,v))?false:true}function setCookie(k,v){if(typeof $.cookie==='function'){return($.cookie(k,v,{expires:7}))?true:false}else{return false}}function getLocal(k){return(localStorage.getItem(k))?localStorage.getItem(k):false}function getSession(k){return(sessionStorage.getItem(k))?sessionStorage.getItem(k):false}function getCookie(a){if(typeof $.cookie==='function'){return($.cookie(a))?$.cookie(a):false}else{return false}}function getStorage(a){var b={},x;$.each($('#'+a.form+' :text, :password, :file, input:hidden, input:checkbox:checked, input:radio:checked, textarea'),function(k,v){if((validateString(v.name)!==false)&&(validateString(getItem(a.storage,v.name))!==false)){b[v.name]=((a.aes)&&(a.key)&&(x!==false))?GibberishAES.dec(getItem(a.storage,v.name),a.uuid):getItem(a.storage,v.name)}});return b}function setForm(c,d){$.each(d,function(a,b){if(($('#'+c.form+' input[name='+a+']').attr('name')===a)&&(validateString(b)!==false)){$('#'+c.form+' input[name='+a+']').val(b)}})}function saveForm(a){$.each($('#'+a.form+' :text, :password, :file, input:hidden, input:checkbox:checked, input:radio:checked, textarea'),function(k,v){if((validateString(v.value)!==false)&&(validateString(v.name)!==false)){((a.aes)&&(a.key))?setItem(a.storage,v.name,GibberishAES.enc(v.value,a.uuid)):setItem(a.storage,v.name,v.value)}})}function validateString(a){return((a===false)||(a.length===0)||(!a)||(a===null)||(a==='')||(typeof a==='undefined'))?false:true}function validateStorage(a){return((window[a])&&(typeof window[a]=='object'))?true:false}function genUUID(a){var b='0123456789abcdef'.split('');var c=[],rnd=Math.random,r;c[8]=c[13]=c[18]=c[23]='-';c[14]='4';for(var i=0;i<36;i++){if(!c[i]){r=0|rnd()*16;c[i]=b[(i==19)?(r&0x3)|0x8:r&0xf]}}return(a!==null)?c.join('').replace(/-/g,'').split('',a).join(''):c.join('')}function handleKey(a){if(a.aes){a.key=(getItem(a.storage,'uuid'))?getItem(a.storage,'uuid'):genUUID(null);setItem(a.storage,'uuid',a.key)}}if(methods[f]){return methods[f].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof f==='object'||!f){return methods.init.apply(this,arguments)}else{$.error('Method '+f+' does not exist on '+opts.name)}}})(jQuery);
